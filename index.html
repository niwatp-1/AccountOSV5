<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HomePro B2B Owner OS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans Thai"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; box-shadow: inset 0 0 6px rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; box-shadow: inset 2px 2px 2px rgba(255,255,255,0.25), inset -2px -2px 2px rgba(0,0,0,0.25); }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeIn 0.5s ease-out forwards; }

        /* =========================================
           3D UI (Neumorphism / Soft UI) Styles
           ========================================= */
        
        /* Cards */
        .card-3d {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 1);
            border: 1px solid #e2e8f0;
            border-bottom-width: 4px;
            border-bottom-color: #cbd5e1;
            transition: all 0.2s ease;
        }
        .card-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -2px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 1);
            border-bottom-color: #94a3b8;
        }
        .card-3d-active {
            background: #f8fafc;
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.06), inset 0 2px 4px rgba(0,0,0,0.04), 0 1px 0 rgba(255,255,255,1);
            border: 1px solid #cbd5e1;
            border-top-width: 3px;
            border-top-color: #94a3b8;
            transform: translateY(2px);
        }
        .card-3d-purple {
            background: linear-gradient(145deg, #fdf4ff, #faf5ff);
            box-shadow: 0 10px 20px -5px rgba(168, 85, 247, 0.15), 0 4px 6px -2px rgba(168, 85, 247, 0.05), inset 0 1px 0 rgba(255, 255, 255, 1);
            border: 1px solid #e9d5ff;
            border-bottom-width: 4px;
            border-bottom-color: #d8b4fe;
        }

        /* Primary Blue Button */
        .btn-3d-blue {
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            box-shadow: 0 4px 0 #1d4ed8, 0 6px 10px rgba(37, 99, 235, 0.3), inset 0 1px 0 rgba(255,255,255,0.25);
            border: 1px solid #1e40af;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-3d-blue:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #1d4ed8, 0 2px 4px rgba(37, 99, 235, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .btn-3d-blue:disabled { opacity: 0.7; transform: translateY(4px); box-shadow: 0 0 0 #1d4ed8; cursor: not-allowed; }

        /* Green Success Button */
        .btn-3d-green {
            background: linear-gradient(to bottom, #22c55e, #16a34a);
            box-shadow: 0 4px 0 #15803d, 0 6px 10px rgba(22, 163, 74, 0.3), inset 0 1px 0 rgba(255,255,255,0.25);
            border: 1px solid #14532d;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-3d-green:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #15803d, inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .btn-3d-green:disabled { opacity: 0.7; transform: translateY(4px); box-shadow: 0 0 0 #15803d; }

        /* Dark / Black Button */
        .btn-3d-dark {
            background: linear-gradient(to bottom, #1e293b, #0f172a);
            box-shadow: 0 4px 0 #020617, 0 6px 10px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.15);
            border: 1px solid #000000;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-3d-dark:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #020617, inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .btn-3d-dark:disabled { opacity: 0.7; transform: translateY(4px); box-shadow: 0 0 0 #020617; }

        /* White / Secondary Button */
        .btn-3d-white {
            background: linear-gradient(to bottom, #ffffff, #f1f5f9);
            box-shadow: 0 4px 0 #cbd5e1, 0 6px 10px rgba(0, 0, 0, 0.06), inset 0 1px 0 #ffffff;
            border: 1px solid #94a3b8;
            color: #334155;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-3d-white:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #cbd5e1, inset 0 1px 0 rgba(255,255,255,0.5);
            background: #e2e8f0;
        }

        /* Inputs & Textareas */
        .input-3d {
            background: #f8fafc;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.08), inset 0 0 0 1px rgba(0,0,0,0.03), 0 1px 0 rgba(255,255,255,1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            outline: none !important;
        }
        .input-3d:focus {
            background: #ffffff;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.03), 0 0 0 3px rgba(59,130,246,0.25);
            border-color: #3b82f6;
        }

        /* Sidebar */
        .sidebar-3d {
            background: linear-gradient(160deg, #1e293b 0%, #0f172a 100%);
            box-shadow: inset -1px 0 0 rgba(255,255,255,0.05), 5px 0 25px rgba(0,0,0,0.4);
            border-right: 1px solid #334155;
        }

        /* Avatars & Icon Boxes */
        .avatar-3d {
            box-shadow: 0 4px 6px rgba(0,0,0,0.15), inset 0 2px 4px rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.8);
        }
        .icon-box-3d {
            background: linear-gradient(135deg, #ffffff, #f1f5f9);
            box-shadow: 0 4px 6px -1px rgba(0,0,0, 0.1), inset 0 1px 0 #ffffff;
            border: 1px solid #e2e8f0;
        }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <!-- Babel -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Users, LayoutDashboard, TrendingUp, Calendar, Phone, MapPin, 
            FileText, Clock, AlertCircle, Search, ChevronRight, PlusCircle, 
            CheckCircle2, ArrowUpRight, ArrowLeft, Save, Loader2, RefreshCcw,
            Menu, X, UserPlus, Briefcase, Bell, CheckCircle, Filter, Building2, 
            Database, LogOut, Lock, Shield, UserCog, Trash2, Map, CalendarCheck, 
            MoreVertical, CreditCard, Hash, List, Activity, Pencil, MoreHorizontal, 
            User, DollarSign, Download, Settings, Camera, UserMinus
        } from 'lucide-react';

        // --- Configuration ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJ0UuO4nCEDEKujCgWy-P99VgQw7qLhWedJp48oa8sOuUJaAg8VbOQMYeTuy83YQ8/exec"; 

        // Data Lists
        const B2B_CATEGORIES = ["1. ออฟฟิศ/สำนักงาน", "2. โครงการอสังหาริมทรพย์/บริษัทรับสร้างบ้าน", "3. ช่าง", "4. สถาปนิก/วิศวกร/ออกแบบตกแต่ง", "5. ธุรกิจที่พักอาศัย ", "6. โรงแรม/รีสอร์ท/สปา", "7. ธุรกิจอาหารและเครื่องดื่ม", "8. บริการด้านสุขภาพ", "9. โรงงานอุตสาหกรรม", "10. หน่วยงานราชการ/สถานศึกษา/วัด", "11. ร้านค้าช่วงนายหน้า", "12. Other (อื่นๆ)"];
        const PROVINCES = ["กรุงเทพมหานคร", "กระบี่", "กาญจนบุรี", "กาฬสินธุ์", "กำแพงเพชร", "ขอนแก่น", "จันทบุรี", "ฉะเชิงเทรา", "ชลบุรี", "ชัยนาท", "ชัยภูมิ", "ชุมพร", "เชียงราย", "เชียงใหม่", "ตรัง", "ตราด", "ตาก", "นครนายก", "นครปฐม", "นครพนม", "นครราชสีมา", "นครศรีธรรมราช", "นครสวรรค์", "นนทบุรี", "นราธิวาส", "น่าน", "บึงกาฬ", "บุรีรัมย์", "ปทุมธานี", "ประจวบคีรีขันธ์", "ปราจีนบุรี", "ปัตตานี", "พระนครศรีอยุธยา", "พะเยา", "พังงา", "พัทลุง", "พิจิตร", "พิษณุโลก", "เพชรบุรี", "เพชรบูรณ์", "แพร่", "ภูเก็ต", "มหาสารคาม", "มุกดาหาร", "แม่ฮ่องสอน", "ยโสธร", "ยะลา", "ร้อยเอ็ด", "ระนอง", "ระยอง", "ราชบุรี", "ลพบุรี", "ลำปาง", "ลำพูน", "เลย", "ศรีสะเกษ", "สกลนคร", "สงขลา", "สตูล", "สมุทรปราการ", "สมุทรสงคราม", "สมุทรสาคร", "สระแก้ว", "สระบุรี", "สิงห์บุรี", "สุโขทัย", "สุพรรณบุรี", "สุราษฎร์ธานี", "สุรินทร์", "หนองคาย", "หนองบัวลำภู", "อ่างทอง", "อำนาจเจริญ", "อุดรธานี", "อุตรดิตถ์", "อุทัยธานี", "อุบลราชธานี"];

        // --- Helper Functions ---
        const removeDuplicates = (array) => {
            const seen = new Set();
            return array.filter(item => {
                const duplicate = seen.has(item.id);
                seen.add(item.id);
                return !duplicate;
            });
        };

        const getStatusColor = (status) => {
            if (!status) return 'bg-slate-100 text-slate-700 border-slate-200';
            if (status === 'Active') return 'bg-green-100 text-green-700 border-green-200';
            if (status.includes('3M')) return 'bg-blue-100 text-blue-700 border-blue-200';
            if (status.includes('6M')) return 'bg-yellow-100 text-yellow-800 border-yellow-200';
            if (status.includes('1Y')) return 'bg-red-100 text-red-700 border-red-200';
            return 'bg-slate-100 text-slate-700 border-slate-200';
        };

        const getAvatarColor = (status) => {
             if (!status) return 'bg-slate-400';
             if (status === 'Active') return 'bg-green-600';
             if (status.includes('3M')) return 'bg-blue-600';
             if (status.includes('6M')) return 'bg-yellow-500';
             if (status.includes('1Y')) return 'bg-red-600';
             return 'bg-slate-400';
        };

        const isDateInRange = (date, start, end) => {
            if (!date) return false;
            const d = new Date(date);
            const s = start ? new Date(start) : null;
            const e = end ? new Date(end) : null;
            if (isNaN(d.getTime())) return false;
            d.setHours(0,0,0,0); if(s) s.setHours(0,0,0,0); if(e) e.setHours(0,0,0,0);
            if (s && d < s) return false;
            if (e && d > e) return false;
            return true;
        };

        const safeDate = (d) => {
            const date = new Date(d);
            return isNaN(date.getTime()) ? new Date() : date;
        };

        const safeDateStr = (d) => {
            if (!d) return '';
            const date = new Date(d);
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        };

        const getTodayStr = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getFirstDayOfMonthStr = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}-01`;
        };

        const getFirstDayOfYearStr = () => {
            const d = new Date();
            return `${d.getFullYear()}-01-01`;
        };

        const formatThaiDate = (date) => {
            if (!date) return '-';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '-';
            if (d.getFullYear() < 1900) return '-';
            return d.toLocaleDateString('th-TH', { 
                timeZone: 'Asia/Bangkok',
                year: 'numeric', month: '2-digit', day: '2-digit' 
            });
        };

        const formatThaiTime = (date) => {
            if (!date) return '-';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleTimeString('th-TH', { 
                timeZone: 'Asia/Bangkok',
                hour: '2-digit', minute: '2-digit' 
            });
        };

        // --- Components ---
        const StatCard = ({ title, value, subtext, trend, onClick, active, color = 'blue' }) => (
            <div onClick={onClick} className={`p-4 md:p-6 rounded-xl transition-all cursor-pointer ${active ? `card-3d-active border-${color}-400` : 'card-3d'}`}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-slate-500 text-sm font-medium">{title}</p>
                        <h3 className="text-xl md:text-2xl font-bold text-slate-800 mt-1">{value}</h3>
                    </div>
                    <div className={`p-2 rounded-full icon-box-3d ${trend === 'up' ? 'text-green-600' : 'text-red-600'}`}>
                        <TrendingUp size={20} className={trend === 'down' ? 'rotate-180' : ''} />
                    </div>
                </div>
                <p className="text-xs text-slate-400 mt-4">{subtext}</p>
                {active && <div className={`mt-2 text-xs font-bold text-${color}-600 flex items-center gap-1`}><CheckCircle size={12}/> กำลังแสดงผล</div>}
            </div>
        );

        const Toast = ({ message, onClose }) => (
            <div className="fixed top-5 right-5 z-50 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 toast-enter"><CheckCircle size={20} className="text-green-400" /><span className="text-sm font-medium">{message}</span><button onClick={onClose} className="ml-2 text-slate-400 hover:text-white"><X size={16}/></button></div>
        );

        const LoginScreen = ({ onLogin, loading, error }) => {
            const [u, setU] = useState(''); const [p, setP] = useState('');
            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-100 p-4 relative overflow-hidden">
                    {/* Decorative Background Elements */}
                    <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-blue-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
                    <div className="absolute top-[-10%] right-[-10%] w-96 h-96 bg-purple-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
                    <div className="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-pink-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000"></div>
                    
                    <div className="card-3d p-8 rounded-2xl w-full max-w-md fade-in-up relative z-10">
                        <div className="flex flex-col items-center mb-8">
                            <div className="h-16 w-16 btn-3d-blue rounded-2xl flex items-center justify-center mb-4">
                                <span className="text-white text-2xl font-bold drop-shadow-md">HP</span>
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800">B2B Owner OS</h2>
                            <p className="text-slate-500 text-sm mt-1">ระบบบริหารจัดการลูกค้าสัมพันธ์</p>
                        </div>
                        <form onSubmit={e => { e.preventDefault(); onLogin(u, p); }} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">รหัสพนักงาน / ชื่อผู้ใช้</label>
                                <div className="relative">
                                    <Users className="absolute left-3 top-2.5 text-slate-400 z-10" size={20} />
                                    <input type="text" value={u} onChange={e => setU(e.target.value)} className="w-full pl-10 pr-4 py-2.5 input-3d rounded-lg" placeholder="เช่น admin" autoFocus />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-2.5 text-slate-400 z-10" size={20} />
                                    <input type="password" value={p} onChange={e => setP(e.target.value)} className="w-full pl-10 pr-4 py-2.5 input-3d rounded-lg" placeholder="••••••••" />
                                </div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded border border-red-100 shadow-inner">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full btn-3d-blue text-white py-3 rounded-lg font-bold flex justify-center items-center gap-2">
                                {loading ? <Loader2 size={20} className="animate-spin" /> : 'เข้าสู่ระบบ'}
                            </button>
                        </form>
                    </div>
                    <p className="mt-8 text-xs text-slate-400 text-center relative z-10 font-medium">B2B Owner OS 2025-2026; All rights reserved</p>
                </div>
            );
        };

        function B2BAppFullStack() {
            const [user, setUser] = useState(null);
            const [customers, setCustomers] = useState([]);
            const [activities, setActivities] = useState([]);
            const [visitPlans, setVisitPlans] = useState([]);
            const [sales, setSales] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [toastMsg, setToastMsg] = useState(null);
            const [loginError, setLoginError] = useState('');
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedCustomerId, setSelectedCustomerId] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isAddCustomerOpen, setIsAddCustomerOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeFilter, setActiveFilter] = useState('ALL');
            const [dashboardDateRange, setDashboardDateRange] = useState({ start: getFirstDayOfMonthStr(), end: getTodayStr() });
            const [customerDateRange, setCustomerDateRange] = useState({ start: getFirstDayOfMonthStr(), end: getTodayStr() });
            const [newActivityNote, setNewActivityNote] = useState('');
            const [editingCustomerId, setEditingCustomerId] = useState(null);
            const [isUpdateRevenueOpen, setIsUpdateRevenueOpen] = useState(false);
            const [revenueUpdateForm, setRevenueUpdateForm] = useState({ id: null, amount: '', date: getTodayStr() });
            const [isAddVisitPlanOpen, setIsAddVisitPlanOpen] = useState(false);
            const [newVisitPlan, setNewVisitPlan] = useState({ customerId: '', date: '', time: '10:00', objective: '' });
            const [newCustomerForm, setNewCustomerForm] = useState({ name: '', customerName: '', contact: '', phone: '', category: B2B_CATEGORIES[0], province: 'กรุงเทพมหานคร', tier: 'VIP', status: 'Active', strategy: '', homeCard: '', bizId: '' });
            const [newUserForm, setNewUserForm] = useState({ username: '', password: '', displayName: '', role: 'user' });
            const [settingsForm, setSettingsForm] = useState({ displayName: '', password: '', photoURL: '' });
            const [dueVisitCount, setDueVisitCount] = useState(0);
            
            const [imgError, setImgError] = useState(false);

            const showToast = (msg) => { setToastMsg(msg); setTimeout(() => setToastMsg(null), 3000); };

            useEffect(() => { 
                if (user) {
                    setSettingsForm({ displayName: user.displayName || '', password: '', photoURL: user.photoURL || '' });
                    setImgError(false);
                }
            }, [user]);

            useEffect(() => {
                const checkDueVisits = () => {
                    if (!visitPlans.length) { setDueVisitCount(0); return; }
                    const now = new Date(); const todayStr = getTodayStr(); const currentHours = now.getHours(); const currentMinutes = now.getMinutes();
                    const count = visitPlans.filter(p => {
                        if (user?.role !== 'admin' && p.owner !== user?.username) return false;
                        if (p.status !== 'Planned') return false;
                        let pd = p.date;
                        if (pd && typeof pd === 'string') { if (pd.includes('T')) pd = pd.split('T')[0]; else if (pd.includes(' ')) pd = pd.split(' ')[0]; }
                        if (pd < todayStr) return true;
                        if (pd > todayStr) return false;
                        if (!p.time) return true;
                        let ph, pm;
                        if (p.time.includes('T')) { const d = new Date(p.time); ph = d.getHours(); pm = d.getMinutes(); } else if (p.time.includes(':')) { [ph, pm] = p.time.split(':').map(Number); } else return true;
                        if (ph < currentHours) return true;
                        if (ph === currentHours && pm <= currentMinutes) return true;
                        return false;
                    }).length;
                    setDueVisitCount(count);
                };
                checkDueVisits(); const interval = setInterval(checkDueVisits, 60000); return () => clearInterval(interval);
            }, [visitPlans, user]);

            const loadData = async (currUser = user) => {
                setLoading(true);
                if (GOOGLE_SCRIPT_URL) {
                    try {
                        const res = await fetch(GOOGLE_SCRIPT_URL + `?username=${encodeURIComponent(currUser?.username)}&role=${encodeURIComponent(currUser?.role)}`);
                        const data = await res.json();
                        if (data) {
                            setActivities((data.activities || []).map(a => ({...a, date: a.date ? new Date(a.date) : new Date()})).sort((a, b) => b.date - a.date));
                            setVisitPlans((data.visitPlans || []).map(p => ({...p})).sort((a, b) => new Date(a.date) - new Date(b.date)));
                            setSales((data.sales || []).map(s => ({...s, date: s.date ? new Date(s.date) : new Date()})).sort((a, b) => b.date - a.date));
                            setCustomers(removeDuplicates(data.customers || []));
                            if (currUser?.role === 'admin' && data.users) setAllUsers(data.users);
                            
                            if (data.currentUser) {
                                const updatedUser = { ...currUser, ...data.currentUser };
                                if (JSON.stringify(updatedUser) !== JSON.stringify(currUser)) {
                                    setUser(updatedUser);
                                    localStorage.setItem('b2b_current_user', JSON.stringify(updatedUser));
                                    setImgError(false);
                                }
                            }
                        }
                    } catch (e) {}
                } else {
                    if (currUser?.role === 'admin' && allUsers.length === 0) setAllUsers([{ id: '1', username: 'admin', displayName: 'System Admin', role: 'admin' }, { id: '2', username: 'sale01', displayName: 'Sale Rep 1', role: 'user' }]);
                }
                setLoading(false);
            };

            const handleLogin = async (u, p) => {
                setLoginError(''); setIsLoggingIn(true);
                if (GOOGLE_SCRIPT_URL) {
                    try {
                        const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', username: u, password: p }) });
                        const result = await res.json();
                        if (result.status === 'success') { localStorage.setItem('b2b_current_user', JSON.stringify(result.user)); setUser(result.user); await loadData(result.user); } else { setLoginError(result.message); }
                    } catch (e) { setLoginError('Connection Error'); }
                } else {
                    await new Promise(r => setTimeout(r, 500));
                    if (u && p) { const mockUser = { username: u, displayName: u, role: (u === 'admin' && p === 'admin') ? 'admin' : 'user' }; localStorage.setItem('b2b_current_user', JSON.stringify(mockUser)); setUser(mockUser); await loadData(mockUser); } else { setLoginError('Invalid credentials'); }
                }
                setIsLoggingIn(false);
            };

            const handleLogout = () => { 
                try { localStorage.removeItem('b2b_current_user'); } catch(e) {}
                setUser(null); setCustomers([]); setActivities([]); setVisitPlans([]); setSales([]); setAllUsers([]);
                setSettingsForm({ displayName: '', password: '', photoURL: '' }); setCurrentView('dashboard'); 
            };

            const saveDataToSheet = async (type, data) => { if (!GOOGLE_SCRIPT_URL) return; await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'add', type, data }) }); };
            const createUserInSheet = async (userData) => { if (!GOOGLE_SCRIPT_URL) return; return await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addUser', type: 'Users', data: userData }) }).then(r=>r.json()); };
            const updateUserInSheet = async (userData) => { if (!GOOGLE_SCRIPT_URL) return; return await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateUser', type: 'Users', data: userData }) }).then(r=>r.json()); };

            useEffect(() => { const u = localStorage.getItem('b2b_current_user'); if (u) { const pu = JSON.parse(u); setUser(pu); loadData(pu); } else setLoading(false); }, []);

            const handleSaveData = async (coll, newData, id = null) => {
                const item = { id: id || crypto.randomUUID(), ...newData, createdAt: new Date().toISOString() };
                if (coll === 'customers') setCustomers(prev => id ? prev.map(c => c.id === id ? { ...c, ...newData } : c) : (prev.some(c => String(c.name).trim() === String(item.name).trim()) ? prev : [...prev, item]));
                else if (coll === 'activities') setActivities(prev => [...prev, { ...item, date: newData.date ? new Date(newData.date) : new Date() }].sort((a, b) => b.date - a.date));
                else if (coll === 'visitPlans') setVisitPlans(prev => id ? prev.map(x => x.id === id ? { ...x, ...newData } : x) : [...prev, item].sort((a, b) => new Date(a.date) - new Date(b.date)));
                else if (coll === 'sales') setSales(prev => id ? prev.map(s => s.id === id ? { ...s, ...newData } : s).sort((a, b) => b.date - a.date) : [...prev, { ...item, date: newData.date ? new Date(newData.date) : new Date() }].sort((a, b) => b.date - a.date));
                
                if (GOOGLE_SCRIPT_URL) saveDataToSheet(coll, item).catch(console.error);
                return item.id;
            };

            // --- Handlers ---
            const openAddCustomerModal = () => { setEditingCustomerId(null); setNewCustomerForm({ name: '', customerName: '', contact: '', phone: '', category: B2B_CATEGORIES[0], province: 'กรุงเทพมหานคร', tier: 'VIP', status: 'Active', strategy: '', homeCard: '', bizId: '' }); setIsAddCustomerOpen(true); };
            const openEditCustomerModal = (c) => { setEditingCustomerId(c.id); setNewCustomerForm({ name: c.name||'', customerName: c.customerName||'', contact: c.contact||'', phone: c.phone||'', category: c.category||B2B_CATEGORIES[0], province: c.province||'กรุงเทพมหานคร', tier: c.tier||'VIP', status: c.status||'Active', strategy: c.strategy||'', homeCard: c.homeCard||'', bizId: c.bizId||'' }); setIsAddCustomerOpen(true); };
            const handleDeleteCustomer = async (id) => { 
                if (!confirm("ยืนยันลบ?")) return; 
                setCustomers(p => p.filter(c => c.id !== id)); 
                await saveDataToSheet('customers', { id, status: 'Deleted' }); 
                showToast("ลบเรียบร้อย"); 
                if (selectedCustomerId === id) setSelectedCustomerId(null); 
            };
            const handleExportCustomers = () => { const h = ['ชื่อบริษัท','ชื่อลูกค้า','ผู้ติดต่อ','เบอร์โทร','ประเภทธุรกิจ','จังหวัด','Tier','Status','HomeCard','Biz ID']; const csv = [h.join(','), ...filteredCustomers.map(c => [`"${c.name||''}"`,`"${c.customerName||''}"`,`"${c.contact||''}"`,`"${c.phone||''}"`,`"${c.category||''}"`,`"${c.province||''}"`,`"${c.tier||''}"`,`"${c.status||''}"`,`"${c.homeCard||''}"`,`"${c.bizId||''}"`].join(','))].join('\n'); const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'})); link.download = `customers_${getTodayStr()}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleSaveCustomerForm = async (e) => { e.preventDefault(); if (isSubmitting) return; setIsSubmitting(true); try { if (!editingCustomerId && customers.some(c => String(c.name).trim().toLowerCase() === String(newCustomerForm.name).trim().toLowerCase())) { showToast("ชื่อซ้ำ"); setIsSubmitting(false); return; } const data = { ...newCustomerForm, owner: user?.username || 'admin', nextAction: editingCustomerId ? undefined : 'New Account' }; const savedId = await handleSaveData('customers', data, editingCustomerId); if (!editingCustomerId) { await handleSaveData('activities', { customerId: savedId, type: 'System', note: `New customer: ${data.name}`, by: user?.username, date: new Date() }); showToast("เพิ่มสำเร็จ"); setSelectedCustomerId(savedId); setCurrentView('customerDetail'); } else showToast("แก้ไขสำเร็จ"); setIsAddCustomerOpen(false); } catch(e) { showToast("Error"); } finally { setIsSubmitting(false); } };
            
            const handleRecordSale = async (e) => { 
                e.preventDefault(); 
                if(!selectedCustomerId || !revenueUpdateForm.amount) return; 
                setIsSubmitting(true); 
                try { 
                    const amt = Number(revenueUpdateForm.amount); 
                    const dp = revenueUpdateForm.date.split('-'); 
                    const rd = new Date(parseInt(dp[0]), parseInt(dp[1])-1, parseInt(dp[2]), new Date().getHours(), new Date().getMinutes()); 
                    
                    if (revenueUpdateForm.id) {
                        await handleSaveData('sales', { amount: amt, date: rd, by: user?.username }, revenueUpdateForm.id);
                        await handleSaveData('activities', { customerId: selectedCustomerId, type: 'System', note: `แก้ไขยอดขายเป็น: ฿${amt.toLocaleString()} (${formatThaiDate(rd)})`, by: user?.username, date: new Date() }); 
                        showToast("แก้ไขยอดขายแล้ว");
                    } else {
                        await handleSaveData('sales', { customerId: selectedCustomerId, amount: amt, date: rd, note: `ยอดขาย: ฿${amt.toLocaleString()}`, by: user?.username }); 
                        await handleSaveData('activities', { customerId: selectedCustomerId, type: 'Sale', note: `บันทึกยอดขาย: ฿${amt.toLocaleString()} (${formatThaiDate(rd)})`, by: user?.username, date: rd }); 
                        showToast("บันทึกแล้ว"); 
                    }
                    
                    setIsUpdateRevenueOpen(false); 
                    setRevenueUpdateForm({ id: null, amount: '', date: getTodayStr() }); 
                } catch(e) { 
                    showToast("Error"); 
                } finally { 
                    setIsSubmitting(false); 
                } 
            };

            const handleCreateUser = async (e) => { e.preventDefault(); if(!newUserForm.username) return; setIsSubmitting(true); try { const nu = { id: crypto.randomUUID(), username: newUserForm.username, password: newUserForm.password, displayName: newUserForm.displayName || newUserForm.username, role: newUserForm.role, createdAt: new Date().toISOString() }; if(GOOGLE_SCRIPT_URL) await createUserInSheet(nu); setAllUsers(p => [...p, nu]); showToast("User created"); setNewUserForm({ username: '', password: '', displayName: '', role: 'user' }); } catch(e) { showToast("Error"); } finally { setIsSubmitting(false); } };
            const handleDeleteUser = async (targetId) => { if(!confirm("ต้องการลบผู้ใช้งานนี้?")) return; setAllUsers(prev => prev.filter(u => u.id !== targetId)); showToast("ลบผู้ใช้งานเรียบร้อย"); };
            const handleCreateVisitPlan = async (e) => { e.preventDefault(); if(!newVisitPlan.customerId) return; setIsSubmitting(true); try { const c = customers.find(x=>x.id===newVisitPlan.customerId); await handleSaveData('visitPlans', { ...newVisitPlan, customerName: c?c.name:'Unknown', status: 'Planned', owner: user?.username }); showToast("Saved"); setIsAddVisitPlanOpen(false); setNewVisitPlan({ customerId: '', date: getTodayStr(), time: '10:00', objective: '' }); } catch(e) { showToast("Error"); } finally { setIsSubmitting(false); } };
            const handleCompleteVisitPlan = async (p) => { if(!confirm("Confirm?")) return; await handleSaveData('visitPlans', { ...p, status: 'Completed' }, p.id); await handleSaveData('activities', { customerId: p.customerId, type: 'Visit', note: `Completed: ${p.objective}`, by: user?.username, date: new Date() }); showToast("Checked-in"); };
            const handleDeleteVisitPlan = async (pid) => { if(!confirm("Delete?")) return; setVisitPlans(p => p.filter(x => x.id !== pid)); await handleSaveData('visitPlans', { status: 'Cancelled' }, pid); showToast("Deleted"); };
            const handleAddActivity = async (t) => { if(!newActivityNote.trim()) return; await handleSaveData('activities', { customerId: selectedCustomerId, type: t, note: newActivityNote, by: user?.username, date: new Date() }); setNewActivityNote(''); showToast("Posted"); };
            const handleSettingsFileChange = (e) => { const f = e.target.files[0]; if(f) { if(f.size>2*1024*1024){alert("รูปขนาดเกิน 2MB");return;} const r = new FileReader(); r.onloadend = () => setSettingsForm(p => ({ ...p, photoURL: r.result })); r.readAsDataURL(f); } };
            const handleSaveSettings = async () => { setIsSubmitting(true); try { let url = settingsForm.photoURL; if(url && url.startsWith('data:') && GOOGLE_SCRIPT_URL) { try { const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'uploadProfileImage', username: user.username, image: url }) }); const r = await res.json(); if(r.url) url = r.url; } catch(e){} } const u = { ...user, ...settingsForm, photoURL: url }; if(!settingsForm.password) delete u.password; setUser(u); localStorage.setItem('b2b_current_user', JSON.stringify(u)); if(GOOGLE_SCRIPT_URL) await updateUserInSheet(u); showToast("Saved"); setImgError(false); } catch(e) { showToast("Error"); } finally { setIsSubmitting(false); } };
            const seedData = async () => { setLoading(true); const demos = [{ name: 'Demo Corp', contact: 'Mr. A', phone: '0999999999', category: B2B_CATEGORIES[0], tier: 'Standard', status: 'Active' }]; for(const c of demos) { const id = await handleSaveData('customers', c); await handleSaveData('activities', { customerId: id, type: 'System', note: 'Demo', by: user?.username, date: new Date() }); } setLoading(false); showToast("Demo Data Created"); };

            // --- AUTO STATUS LOGIC ---
            const lastSaleMap = useMemo(() => {
                const map = {};
                sales.forEach(s => {
                    if (!map[s.customerId] || new Date(s.date) > map[s.customerId]) {
                        map[s.customerId] = new Date(s.date);
                    }
                });
                return map;
            }, [sales]);

            const getCalculatedStatus = (c) => {
                const lastDate = lastSaleMap[c.id];
                if (!lastDate) return c.status || 'Active'; 

                const today = new Date();
                const diffTime = today - lastDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays <= 90) return 'Active';
                if (diffDays <= 180) return 'Inactive 3M';
                if (diffDays <= 365) return 'Inactive 6M';
                return 'Inactive 1Y';
            };

            const customersWithStatus = useMemo(() => {
                return customers.map(c => ({
                    ...c,
                    status: getCalculatedStatus(c) 
                }));
            }, [customers, lastSaleMap]);

            const filteredCustomers = useMemo(() => removeDuplicates(customersWithStatus).filter(c => { 
                if(user?.role!=='admin' && c.owner!==user?.username) return false; 
                const s = searchTerm.toLowerCase(); 
                
                const isMatchSearch = s === '' || [
                    c.name, c.customerName, c.contact, c.phone, 
                    c.category, c.province, c.tier, c.status, 
                    c.homeCard, c.bizId, c.strategy, c.owner
                ].some(val => val && String(val).toLowerCase().includes(s));

                const isMatchFilter = (activeFilter==='ALL' || (activeFilter==='INACTIVE' && c.status.includes('Inactive')) || (activeFilter==='TOP20' && c.tier==='Top 20'));
                
                return isMatchSearch && isMatchFilter; 
            }), [customersWithStatus, searchTerm, activeFilter, user]);
            
            const myRevenue = useMemo(() => sales.filter(s => { 
                const c = customers.find(cu => cu.id === s.customerId); 
                if(c?.owner!==user?.username) return false; 
                return isDateInRange(s.date, dashboardDateRange.start, dashboardDateRange.end); 
            }).reduce((a,b)=>a+(Number(b.amount)||0),0), [sales, dashboardDateRange, customers, user]);
            
            const myActiveCount = customersWithStatus.filter(c => c.owner === user?.username && c.status === 'Active').length;
            const myInactiveCount = customersWithStatus.filter(c => c.owner === user?.username && c.status.includes('Inactive')).length;
            const todayStr = new Date().toISOString().split('T')[0];
            const myTodayPlans = visitPlans.filter(p => p.owner === user?.username && p.date === todayStr && p.status !== 'Completed').length;

            const teamRevenue = useMemo(() => sales.filter(s => { 
                const c = customers.find(cu => cu.id === s.customerId); 
                if(!c) return false;
                return isDateInRange(s.date, dashboardDateRange.start, dashboardDateRange.end); 
            }).reduce((a,b)=>a+(Number(b.amount)||0),0), [sales, dashboardDateRange, customers]);
            
            const teamActiveCount = customersWithStatus.filter(c => c.status === 'Active').length;
            const teamInactiveCount = customersWithStatus.filter(c => c.status.includes('Inactive')).length;
            const teamTodayPlans = visitPlans.filter(p => p.date === todayStr && p.status !== 'Completed').length;


            const recentActivities = useMemo(() => activities.filter(a => { const c = customers.find(cu => cu.id === a.customerId); if(user?.role!=='admin' && c?.owner!==user?.username) return false; return isDateInRange(a.date, dashboardDateRange.start, dashboardDateRange.end); }).slice(0,50).map(a => ({...a, customerName: customers.find(c=>c.id===a.customerId)?.name||'Unknown'})).filter(a => a.customerName.toLowerCase().includes(searchTerm.toLowerCase())), [activities, customers, searchTerm, dashboardDateRange, user]);
            
            const selectedCustomer = useMemo(() => customersWithStatus.find(c => c.id === selectedCustomerId), [customersWithStatus, selectedCustomerId]);
            const currentCustomerActivities = useMemo(() => selectedCustomer ? activities.filter(a => a.customerId === selectedCustomerId) : [], [activities, selectedCustomerId]);
            const currentCustomerSales = useMemo(() => selectedCustomer ? sales.filter(s => s.customerId === selectedCustomerId).sort((a,b) => new Date(b.date) - new Date(a.date)) : [], [sales, selectedCustomerId]);

            if (loading) return <div className="h-screen flex items-center justify-center bg-slate-50"><Loader2 className="animate-spin text-blue-600 mb-2" size={32}/><p className="text-slate-500 font-medium">{user ? `กำลังโหลดข้อมูลของคุณ ${user.displayName||user.username}...` : 'Connecting...'}</p></div>;
            if (!user) return <LoginScreen onLogin={handleLogin} loading={isLoggingIn} error={loginError} />;

            // --- Render Functions ---
            const renderAddCustomerModal = () => isAddCustomerOpen && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="card-3d rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="px-6 py-4 border-b flex justify-between bg-slate-50 sticky top-0 z-10"><h3 className="font-bold flex gap-2">{editingCustomerId?<Pencil size={20}/>:<UserPlus size={20}/>} {editingCustomerId?'แก้ไข':'เพิ่ม'}ลูกค้า</h3><button onClick={()=>setIsAddCustomerOpen(false)} className="text-slate-400 hover:text-slate-800"><X size={20}/></button></div>
                        <form onSubmit={handleSaveCustomerForm} className="p-4 md:p-6 space-y-4">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label className="text-sm block mb-1 font-medium">ชื่อบริษัท*</label><input required className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.name} onChange={e=>setNewCustomerForm({...newCustomerForm, name:e.target.value})}/></div><div><label className="text-sm block mb-1 font-medium">ชื่อลูกค้า</label><input className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.customerName} onChange={e=>setNewCustomerForm({...newCustomerForm, customerName:e.target.value})}/></div></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label className="text-sm block mb-1 font-medium">HomeCard</label><input className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.homeCard} onChange={e=>setNewCustomerForm({...newCustomerForm, homeCard:e.target.value})}/></div><div><label className="text-sm block mb-1 font-medium">Biz ID</label><input className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.bizId} onChange={e=>setNewCustomerForm({...newCustomerForm, bizId:e.target.value})}/></div></div>
                            <div><label className="text-sm block mb-1 font-medium">ประเภทธุรกิจ</label><select className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.category} onChange={e=>setNewCustomerForm({...newCustomerForm, category:e.target.value})}>{B2B_CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label className="text-sm block mb-1 font-medium">เบอร์โทร</label><input className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.phone} onChange={e=>setNewCustomerForm({...newCustomerForm, phone:e.target.value})}/></div><div><label className="text-sm block mb-1 font-medium">จังหวัด</label><select className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.province} onChange={e=>setNewCustomerForm({...newCustomerForm, province:e.target.value})}>{PROVINCES.map(p=><option key={p} value={p}>{p}</option>)}</select></div></div>
                            <div><label className="text-sm block mb-1 font-medium">ผู้ติดต่อ</label><input className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.contact} onChange={e=>setNewCustomerForm({...newCustomerForm, contact:e.target.value})}/></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label className="text-sm block mb-1 font-medium">Tier</label><select className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.tier} onChange={e=>setNewCustomerForm({...newCustomerForm, tier:e.target.value})}><option>VIP</option><option>Top 100</option><option>Top 20</option><option>Top 10</option></select></div>
                                <div>
                                    <label className="text-sm block mb-1 font-medium">Status</label>
                                    <select className="input-3d rounded-lg px-3 py-2 w-full" value={newCustomerForm.status} onChange={e=>setNewCustomerForm({...newCustomerForm, status:e.target.value})}>
                                        <option>Active</option><option>Inactive 3M</option><option>Inactive 6M</option><option>Inactive 1Y</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-3 pt-4"><button type="button" onClick={()=>setIsAddCustomerOpen(false)} className="flex-1 btn-3d-white py-2 rounded-lg font-medium">ยกเลิก</button><button type="submit" disabled={isSubmitting} className="flex-1 btn-3d-blue text-white py-2 rounded-lg font-medium">{isSubmitting?<Loader2 className="animate-spin mx-auto"/>:'บันทึก'}</button></div>
                        </form>
                    </div>
                </div>
            );

            const renderUpdateRevenueModal = () => isUpdateRevenueOpen && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="card-3d rounded-2xl w-full max-w-sm">
                        <div className="px-6 py-4 border-b flex justify-between bg-green-50 sticky top-0 rounded-t-2xl"><h3 className="font-bold text-green-700 flex gap-2"><DollarSign/> {revenueUpdateForm.id ? 'แก้ไขยอดขาย' : 'บันทึกยอดขาย'}</h3><button onClick={()=>setIsUpdateRevenueOpen(false)} className="text-green-700 hover:text-green-900"><X/></button></div>
                        <form onSubmit={handleRecordSale} className="p-6 space-y-4">
                            <div><label className="text-sm block mb-1 font-medium">ยอดขาย (บาท)</label><input required type="number" autoFocus className="input-3d rounded-lg px-3 py-2 w-full text-lg font-bold text-green-700" value={revenueUpdateForm.amount} onChange={e=>setRevenueUpdateForm({...revenueUpdateForm, amount:e.target.value})}/></div>
                            <div><label className="text-sm block mb-1 font-medium">วันที่</label><input required type="date" className="input-3d rounded-lg px-3 py-2 w-full" value={revenueUpdateForm.date} onChange={e=>setRevenueUpdateForm({...revenueUpdateForm, date:e.target.value})}/></div>
                            <div className="flex gap-3 pt-4"><button type="button" onClick={()=>setIsUpdateRevenueOpen(false)} className="flex-1 btn-3d-white py-2 rounded-lg font-medium">ยกเลิก</button><button type="submit" disabled={isSubmitting} className="flex-1 btn-3d-green text-white py-2 rounded-lg font-medium">{isSubmitting?<Loader2 className="animate-spin mx-auto"/>:'ยืนยัน'}</button></div>
                        </form>
                    </div>
                </div>
            );

            const renderAddVisitPlanModal = () => isAddVisitPlanOpen && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="card-3d rounded-2xl w-full max-w-md">
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl"><h3 className="font-bold flex gap-2"><CalendarCheck/> สร้างแผนเข้าเยี่ยม</h3><button onClick={()=>setIsAddVisitPlanOpen(false)} className="text-slate-400 hover:text-slate-800"><X/></button></div>
                        <form onSubmit={handleCreateVisitPlan} className="p-4 md:p-6 space-y-4">
                            <div><label className="text-sm block mb-1 font-medium">ลูกค้า</label><select required className="input-3d rounded-lg px-3 py-2 w-full" value={newVisitPlan.customerId} onChange={e=>setNewVisitPlan({...newVisitPlan, customerId:e.target.value})}><option value="">-- เลือก --</option>{customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label className="text-sm block mb-1 font-medium">วันที่</label><input required type="date" className="input-3d rounded-lg px-3 py-2 w-full" value={newVisitPlan.date} onChange={e=>setNewVisitPlan({...newVisitPlan, date:e.target.value})}/></div><div><label className="text-sm block mb-1 font-medium">เวลา</label><input type="time" className="input-3d rounded-lg px-3 py-2 w-full" value={newVisitPlan.time} onChange={e=>setNewVisitPlan({...newVisitPlan, time:e.target.value})}/></div></div>
                            <div><label className="text-sm block mb-1 font-medium">วัตถุประสงค์</label><textarea className="input-3d rounded-lg px-3 py-2 w-full" rows="3" value={newVisitPlan.objective} onChange={e=>setNewVisitPlan({...newVisitPlan, objective:e.target.value})}/></div>
                            <div className="flex gap-3 pt-4"><button type="button" onClick={()=>setIsAddVisitPlanOpen(false)} className="flex-1 btn-3d-white py-2 rounded-lg font-medium">ยกเลิก</button><button type="submit" disabled={isSubmitting} className="flex-1 btn-3d-blue text-white py-2 rounded-lg font-medium">{isSubmitting?<Loader2 className="animate-spin mx-auto"/>:'บันทึก'}</button></div>
                        </form>
                    </div>
                </div>
            );

            const renderUserSettingsView = () => (
                <div className="space-y-6 animate-in fade-in">
                    <div className="flex justify-between items-center mb-2"><div><h1 className="text-2xl font-bold">ตั้งค่าผู้ใช้งาน</h1><p className="text-slate-500">ข้อมูลส่วนตัวและโปรไฟล์</p></div></div>
                    <div className="card-3d p-8 rounded-2xl max-w-2xl mx-auto">
                        <div className="flex flex-col items-center mb-8">
                            <div className="relative group">
                                <div className="w-32 h-32 rounded-full bg-slate-200 overflow-hidden avatar-3d flex items-center justify-center text-slate-400 text-4xl font-bold bg-cover bg-center" style={{backgroundImage: (settingsForm.photoURL && !imgError) ? `url(${settingsForm.photoURL})` : 'none'}}>
                                    {(!settingsForm.photoURL || imgError) && (user?.displayName||user?.username||"U").substring(0,2).toUpperCase()}
                                    <img src={settingsForm.photoURL} alt="Profile" className="hidden" onError={() => setImgError(true)} onLoad={() => setImgError(false)} />
                                </div>
                                <label className="absolute bottom-0 right-0 btn-3d-blue text-white p-2 rounded-full cursor-pointer"><Camera size={20}/><input type="file" className="hidden" accept="image/*" onChange={handleSettingsFileChange}/></label>
                            </div>
                        </div>
                        <div className="space-y-4">
                            <div><label className="text-sm block mb-1 font-medium">ชื่อที่แสดง</label><input type="text" className="input-3d rounded-lg px-4 py-2.5 w-full" value={settingsForm.displayName} onChange={e=>setSettingsForm({...settingsForm, displayName:e.target.value})}/></div>
                            <div><label className="text-sm block mb-1 font-medium">รหัสผ่านใหม่</label><input type="password" className="input-3d rounded-lg px-4 py-2.5 w-full" value={settingsForm.password} onChange={e=>setSettingsForm({...settingsForm, password:e.target.value})} placeholder="เว้นว่างไว้หากไม่เปลี่ยน"/></div>
                            <div className="pt-6"><button onClick={handleSaveSettings} disabled={isSubmitting} className="w-full btn-3d-dark text-white py-3 rounded-lg font-bold flex justify-center gap-2 disabled:opacity-70">{isSubmitting ? <Loader2 className="animate-spin"/> : <><Save size={20}/> บันทึก</>}</button></div>
                        </div>
                    </div>
                </div>
            );

            const renderCustomerDetailView = () => {
                if(!selectedCustomer) return <div className="p-8 text-center text-slate-500">ไม่พบข้อมูล</div>;
                const lifeTimeRev = sales.filter(s => s.customerId === selectedCustomer.id && isDateInRange(s.date, customerDateRange.start, customerDateRange.end)).reduce((a,b)=>a+(Number(b.amount)||0),0);
                return (
                    <div className="space-y-6 animate-in fade-in">
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4 w-full sm:w-auto"><button onClick={()=>setCurrentView('customerList')} className="p-2 btn-3d-white rounded-lg"><ArrowLeft/></button><div><h1 className="text-2xl font-bold flex items-center gap-2">{selectedCustomer.name} <span className="text-xs bg-yellow-100 text-yellow-800 px-2 rounded-full border border-yellow-200">{selectedCustomer.tier}</span> <span className={`text-xs px-2 rounded-full border ${getStatusColor(selectedCustomer.status)}`}>{selectedCustomer.status}</span></h1>{selectedCustomer.customerName && <p className="text-lg text-slate-700 mt-0.5">{selectedCustomer.customerName}</p>}<div className="flex gap-3 text-slate-500 text-sm mt-1"><span><MapPin size={14} className="inline"/> {selectedCustomer.province}</span><span><Phone size={14} className="inline"/> {selectedCustomer.phone}</span></div></div></div>
                            <div className="flex gap-2 w-full sm:w-auto justify-end">
                                <button onClick={()=>openEditCustomerModal(selectedCustomer)} className="px-4 py-2 btn-3d-white rounded-lg flex items-center gap-2 font-medium"><Pencil size={16}/> แก้ไข</button>
                                <button onClick={()=>{ setRevenueUpdateForm({ id: null, amount: '', date: getTodayStr() }); setIsUpdateRevenueOpen(true); }} className="px-4 py-2 btn-3d-green text-white rounded-lg flex items-center gap-2 font-medium"><DollarSign size={16}/> อัปเดตยอด</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="card-3d p-6 rounded-2xl"><div className="flex justify-between mb-2"><p className="text-slate-500 text-sm font-medium">ยอดขายสะสม</p></div><div className="flex items-center gap-2 text-xs mb-3"><input type="date" value={customerDateRange.start} onChange={e=>setCustomerDateRange({...customerDateRange, start:e.target.value})} className="input-3d rounded px-2 py-1"/><span className="text-slate-400">-</span><input type="date" value={customerDateRange.end} onChange={e=>setCustomerDateRange({...customerDateRange, end:e.target.value})} className="input-3d rounded px-2 py-1"/></div><h3 className="text-3xl font-bold text-green-600 drop-shadow-sm">฿{lifeTimeRev.toLocaleString()}</h3></div>
                            <div className="card-3d p-6 rounded-2xl"><p className="text-slate-500 text-sm font-medium">Next Action</p><div className="mt-4 font-bold text-slate-800">{selectedCustomer.nextAction||'None'}</div><button onClick={()=>{setIsAddVisitPlanOpen(true); setNewVisitPlan({...newVisitPlan, customerId: selectedCustomer.id})}} className="text-xs text-blue-600 mt-3 font-medium hover:underline flex items-center gap-1"><PlusCircle size={14}/> สร้างแผนเข้าเยี่ยม</button></div>
                        </div>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Column */}
                            <div className="space-y-6">
                                {/* ข้อมูลทั่วไป */}
                                <div className="card-3d p-6 rounded-2xl space-y-3 text-sm">
                                    <h3 className="font-bold flex gap-2 mb-4 text-slate-800"><FileText size={18} className="text-blue-500 icon-3d"/> ข้อมูลทั่วไป</h3>
                                    <div className="flex justify-between border-b border-slate-100 pb-2"><span className="text-slate-500">Contact</span><span className="font-medium">{selectedCustomer.contact}</span></div>
                                    <div className="flex justify-between border-b border-slate-100 pb-2"><span className="text-slate-500">Category</span><span className="font-medium">{selectedCustomer.category}</span></div>
                                    <div className="flex justify-between border-b border-slate-100 pb-2"><span className="text-slate-500">HomeCard</span><span className="font-medium">{selectedCustomer.homeCard||'-'}</span></div>
                                    <div className="flex justify-between border-b border-slate-100 pb-2"><span className="text-slate-500">Biz ID</span><span className="font-medium">{selectedCustomer.bizId||'-'}</span></div>
                                    <div className="pt-2"><span className="text-slate-500 block mb-1">Strategy</span><p className="bg-slate-50 p-3 rounded-lg border border-slate-200 shadow-inner">{selectedCustomer.strategy||'-'}</p></div>
                                </div>
                                
                                {/* ประวัติยอดขาย (Sales History) */}
                                <div className="card-3d p-6 rounded-2xl space-y-3 text-sm">
                                    <h3 className="font-bold flex gap-2 mb-4 text-green-700"><DollarSign size={18} className="icon-3d"/> ประวัติยอดขาย</h3>
                                    <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                                        {currentCustomerSales.length === 0 ? <p className="text-slate-400 text-center py-4">ยังไม่มียอดขาย</p> : currentCustomerSales.map(s => (
                                            <div key={s.id} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-200 shadow-sm transition-all hover:-translate-y-0.5 hover:shadow-md">
                                                <div>
                                                    <p className="font-bold text-green-700 text-base">฿{Number(s.amount).toLocaleString()}</p>
                                                    <p className="text-xs text-slate-500">{formatThaiDate(s.date)} • {s.by}</p>
                                                </div>
                                                <button onClick={() => {
                                                    setRevenueUpdateForm({ id: s.id, amount: s.amount, date: safeDateStr(s.date) });
                                                    setIsUpdateRevenueOpen(true);
                                                }} className="text-slate-400 hover:text-blue-600 p-2 hover:bg-slate-50 rounded-lg transition-colors" title="แก้ไขยอดขาย">
                                                    <Pencil size={16}/>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Right Column: Activity Feed */}
                            <div className="lg:col-span-2 card-3d rounded-2xl overflow-hidden h-fit flex flex-col">
                                <div className="p-5 border-b border-slate-100 bg-slate-50 flex justify-between"><h3 className="font-bold flex gap-2 text-slate-800"><Activity size={18} className="text-blue-600 icon-3d"/> Activity Feed</h3></div>
                                <div className="p-5 border-b border-blue-100 bg-blue-50/50">
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="พิมพ์บันทึกกิจกรรม..." className="input-3d rounded-lg px-4 py-2.5 w-full" value={newActivityNote} onChange={e=>setNewActivityNote(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAddActivity('Note')}/>
                                        <button onClick={()=>handleAddActivity('Note')} className="btn-3d-blue text-white px-6 py-2.5 rounded-lg font-medium">Post</button>
                                    </div>
                                    <div className="flex gap-3 mt-3">
                                        <button onClick={()=>handleAddActivity('Call')} className="text-xs px-4 py-1.5 btn-3d-white rounded-full font-medium flex items-center gap-1"><Phone size={12}/> Call Log</button>
                                        <button onClick={()=>handleAddActivity('Meeting')} className="text-xs px-4 py-1.5 btn-3d-white rounded-full font-medium flex items-center gap-1"><Users size={12}/> Meeting</button>
                                    </div>
                                </div>
                                <div className="p-5 space-y-6 max-h-[600px] overflow-y-auto bg-white">
                                    {currentCustomerActivities.map(a=>(
                                        <div key={a.id} className="flex gap-4">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold shrink-0 avatar-3d ${a.type==='Sale'?'bg-green-500':a.type==='Visit'?'bg-blue-500':'bg-slate-500'}`}>{a.type[0]}</div>
                                            <div className="flex-1 pb-5 border-b border-slate-100 last:border-0">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <span className="font-bold text-sm text-slate-800">{a.type}</span>
                                                        <span className="font-normal text-xs text-slate-500 ml-2">by {a.by}</span>
                                                    </div>
                                                    <span className="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100">{safeDate(a.date).toLocaleDateString('th-TH')}</span>
                                                </div>
                                                <p className="text-sm mt-2 text-slate-700 leading-relaxed">{a.note}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {currentCustomerActivities.length===0 && <div className="text-center py-12 opacity-50"><Activity size={40} className="mx-auto mb-3 text-slate-400"/><p className="text-slate-500">ไม่มีกิจกรรม</p></div>}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderVisitPlanView = () => {
                const myPlans = visitPlans.filter(p => user?.role === 'admin' || p.owner === user?.username);
                const upcoming = myPlans.filter(p=>p.status!=='Completed'&&p.status!=='Cancelled');
                const done = myPlans.filter(p=>p.status==='Completed');
                return (
                    <div className="space-y-6 animate-in fade-in">
                        <div className="flex justify-between items-center mb-2"><div><h1 className="text-2xl font-bold">Visit Plan</h1><p className="text-slate-500">จัดการแผนเข้าเยี่ยม</p></div><button onClick={()=>setIsAddVisitPlanOpen(true)} className="flex gap-2 btn-3d-dark text-white px-4 py-2.5 rounded-lg font-medium"><CalendarCheck size={18}/> สร้างแผนใหม่</button></div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"><StatCard title="รอเข้าเยี่ยม" value={upcoming.length} /><StatCard title="เข้าเยี่ยมแล้ว" value={done.length} color="green"/><StatCard title="Completion" value={`${myPlans.length>0?Math.round((done.length/myPlans.length)*100):0}%`} color="slate"/></div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="card-3d rounded-2xl overflow-hidden"><div className="p-5 border-b border-blue-100 bg-blue-50/50 flex justify-between"><h2 className="font-bold flex gap-2 text-blue-900"><Calendar className="text-blue-600 icon-3d"/> Upcoming</h2></div><div className="max-h-[500px] overflow-y-auto divide-y divide-slate-100 bg-white">{upcoming.length===0?<p className="p-8 text-center text-slate-400">ไม่มีแผนงาน</p>:upcoming.map(p=>(<div key={p.id} className="p-5 flex flex-col sm:flex-row justify-between items-start gap-4 hover:bg-slate-50 transition-colors"><div className="flex gap-4 w-full sm:w-auto"><div className="bg-gradient-to-b from-slate-50 to-slate-100 border border-slate-200 p-2 rounded-xl text-center min-w-[65px] shadow-sm"><span className="text-xs text-slate-500 font-bold block uppercase tracking-wider">{safeDate(p.date).toLocaleString('en-US',{month:'short'})}</span><span className="text-2xl font-bold text-slate-800">{safeDate(p.date).getDate()}</span></div><div><h4 className="font-bold text-slate-800 hover:text-blue-600 cursor-pointer text-lg" onClick={()=>{setSelectedCustomerId(p.customerId);setCurrentView('customerDetail')}}>{p.customerName}</h4><p className="text-sm text-slate-500 mt-1 flex items-center gap-1"><Clock size={14}/> {p.time} • {p.objective}</p></div></div><div className="flex gap-2 w-full sm:w-auto justify-end"><button onClick={()=>handleCompleteVisitPlan(p)} className="p-2.5 text-green-600 bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg shadow-sm transition-all hover:-translate-y-0.5"><CheckCircle size={18}/></button><button onClick={()=>handleDeleteVisitPlan(p.id)} className="p-2.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={18}/></button></div></div>))}</div></div>
                            <div className="card-3d rounded-2xl overflow-hidden"><div className="p-5 border-b border-slate-100 bg-slate-50"><h2 className="font-bold flex gap-2 text-slate-800"><CheckCircle2 className="text-green-600 icon-3d"/> History</h2></div><div className="max-h-[500px] overflow-y-auto divide-y divide-slate-50 bg-white">{done.length===0?<p className="p-8 text-center text-slate-400">ไม่มีประวัติ</p>:done.map(p=>(<div key={p.id} className="p-5 flex justify-between hover:bg-slate-50 transition-colors opacity-80"><div className="flex gap-4 items-center"><div className="w-10 h-10 rounded-full bg-green-100 border border-green-200 shadow-sm flex items-center justify-center text-green-600"><CheckCircle2 size={20}/></div><div><h4 className="font-medium text-slate-800">{p.customerName}</h4><p className="text-xs text-slate-500 mt-0.5">Visited {safeDate(p.date).toLocaleDateString('th-TH')}</p></div></div><span className="px-3 py-1 bg-slate-100 text-xs font-medium rounded-full border border-slate-200 self-center">Completed</span></div>))}</div></div>
                        </div>
                    </div>
                );
            };

            const renderCustomerListView = () => (
                <div className="space-y-6 animate-in fade-in">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-2">
                        <div>
                            <h1 className="text-2xl font-bold">รายชื่อลูกค้า</h1>
                            <p className="text-slate-500">Customer Port</p>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-3">
                            <button onClick={handleExportCustomers} className="flex items-center justify-center gap-2 btn-3d-white px-5 py-2.5 rounded-lg w-full sm:w-auto font-medium">
                                <Download size={18}/> <span>Export</span>
                            </button>
                            <button onClick={openAddCustomerModal} className="flex items-center justify-center gap-2 btn-3d-dark text-white px-5 py-2.5 rounded-lg w-full sm:w-auto font-medium">
                                <UserPlus size={18}/> <span>Add Customer</span>
                            </button>
                        </div>
                    </div>
                    <div className="card-3d rounded-2xl overflow-hidden">
                        <div className="p-5 border-b border-slate-100 bg-slate-50 flex items-center gap-2"><Users size={18} className="text-slate-500 icon-3d"/><h2 className="font-bold text-slate-800">รายชื่อ ({filteredCustomers.length})</h2></div>
                        <div className="divide-y divide-slate-100 bg-white">{filteredCustomers.length===0?<p className="p-8 text-center text-slate-500">ไม่พบข้อมูล</p>:filteredCustomers.map(c=>(<div key={c.id} onClick={()=>{setSelectedCustomerId(c.id);setCurrentView('customerDetail')}} className="p-4 md:p-5 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 md:gap-4 hover:bg-blue-50/30 transition-colors cursor-pointer group"><div className="flex items-center gap-4 w-full sm:w-auto"><div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold avatar-3d text-lg ${getAvatarColor(c.status)}`}>{(c.name||'').substring(0,2)}</div><div><h4 className="font-bold text-slate-800 group-hover:text-blue-600 transition-colors text-base">{c.name} {user?.role === 'admin' && <span className="text-[10px] ml-1 bg-purple-100 text-purple-800 px-1.5 py-0.5 rounded border border-purple-200 shadow-sm align-middle"><User size={10} className="inline"/> {c.owner}</span>}</h4><div className="flex flex-wrap gap-2 md:gap-3 text-xs text-slate-500 mt-1.5"><span className="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded border border-slate-200"><Building2 size={10}/> {c.category.substring(0,20)}{c.category.length>20?'...':''}</span><span className="flex items-center gap-1"><MapPin size={12}/> {c.province}</span></div></div></div><div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end"><span className={`text-xs px-3 py-1 rounded-full font-bold border shadow-sm ${getStatusColor(c.status)}`}>{c.status.split(' ')[0]}</span><div className="flex gap-1"><button onClick={(e)=>{e.stopPropagation();openEditCustomerModal(c)}} className="p-2 hover:bg-blue-100 text-slate-400 hover:text-blue-600 rounded-lg transition-colors"><Pencil size={18}/></button><button onClick={(e)=>{e.stopPropagation();handleDeleteCustomer(c.id)}} className="p-2 hover:bg-red-100 text-slate-400 hover:text-red-600 rounded-lg transition-colors"><Trash2 size={18}/></button><ChevronRight className="text-slate-300 ml-2 group-hover:text-blue-400 transition-colors"/></div></div></div>))}</div>
                    </div>
                </div>
            );

            const renderUserManagementView = () => {
                return (
                    <div className="space-y-6 animate-in fade-in duration-500">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-2">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800">จัดการผู้ใช้งาน (User Management)</h1>
                                <p className="text-slate-500">เพิ่มและจัดการสิทธิ์การเข้าใช้งานระบบ</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Create User Form */}
                            <div className="lg:col-span-1">
                                <div className="card-3d p-6 rounded-2xl sticky top-24">
                                    <h2 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><UserPlus size={20} className="text-blue-600 icon-3d"/> สร้าง User ใหม่</h2>
                                    <form onSubmit={handleCreateUser} className="space-y-5">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Username (สำหรับ Login)</label>
                                            <input required type="text" className="w-full input-3d rounded-lg px-4 py-2.5" 
                                                value={newUserForm.username} onChange={(e) => setNewUserForm({...newUserForm, username: e.target.value})} placeholder="Ex. sale01" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                            <input required type="password" className="w-full input-3d rounded-lg px-4 py-2.5" 
                                                value={newUserForm.password} onChange={(e) => setNewUserForm({...newUserForm, password: e.target.value})} placeholder="••••••" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">ชื่อที่แสดง (Display Name)</label>
                                            <input required type="text" className="w-full input-3d rounded-lg px-4 py-2.5" 
                                                value={newUserForm.displayName} onChange={(e) => setNewUserForm({...newUserForm, displayName: e.target.value})} placeholder="Ex. Somchai (Sale)" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Role</label>
                                            <select className="w-full input-3d rounded-lg px-4 py-2.5"
                                                value={newUserForm.role} onChange={(e) => setNewUserForm({...newUserForm, role: e.target.value})}>
                                                <option value="user">User (พนักงานขายทั่วไป)</option>
                                                <option value="admin">Admin (ผู้ดูแลระบบ)</option>
                                            </select>
                                        </div>
                                        <button type="submit" disabled={isSubmitting} className="w-full mt-4 btn-3d-dark text-white py-3 rounded-lg font-bold flex justify-center items-center gap-2 disabled:opacity-70">
                                            {isSubmitting ? <Loader2 size={18} className="animate-spin" /> : 'สร้าง Account'}
                                        </button>
                                    </form>
                                </div>
                            </div>

                            {/* User List */}
                            <div className="lg:col-span-2">
                                <div className="card-3d rounded-2xl overflow-hidden">
                                    <div className="p-5 border-b border-slate-100 bg-slate-50">
                                        <h2 className="font-bold text-slate-800 flex items-center gap-2"><Users size={18} className="text-slate-500 icon-3d"/> รายชื่อผู้ใช้งานในระบบ</h2>
                                        <p className="text-xs text-slate-400 mt-1">{GOOGLE_SCRIPT_URL ? 'ดึงข้อมูลจาก Cloud (Google Sheets)' : 'ข้อมูลในเครื่อง (Local Storage)'}</p>
                                    </div>
                                    <div className="divide-y divide-slate-100 bg-white">
                                        {allUsers.length === 0 ? (
                                            <div className="p-10 text-center text-slate-500 italic opacity-60">
                                                <Database className="mx-auto mb-3 drop-shadow" size={40}/>
                                                ยังไม่มีรายชื่อผู้ใช้งาน
                                            </div>
                                        ) : (
                                            allUsers.map((u, i) => (
                                                <div key={i} className="p-5 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 hover:bg-slate-50 transition-colors group">
                                                    <div className="flex items-center gap-4 w-full sm:w-auto">
                                                        <div className="w-10 h-10 rounded-full bg-slate-200 avatar-3d flex items-center justify-center font-bold text-slate-600">
                                                            {u.username.substring(0,2).toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <p className="font-bold text-slate-800">{u.displayName}</p>
                                                            <p className="text-xs text-slate-500 mt-0.5 font-mono">@{u.username}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                                        <span className={`text-xs px-3 py-1 rounded-full font-bold border shadow-sm ${u.role === 'admin' ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>
                                                            {u.role.toUpperCase()}
                                                        </span>
                                                        {u.username !== user.username && (
                                                            <button onClick={() => handleDeleteUser(u.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors opacity-100 sm:opacity-0 sm:group-hover:opacity-100">
                                                                <UserMinus size={18}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderDashboardView = () => {
                return (
                    <div className="space-y-6 animate-in fade-in duration-500">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-2">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800">Overview</h1>
                                <p className="text-slate-500">
                                    {GOOGLE_SCRIPT_URL 
                                        ? <span className="flex items-center gap-1 text-green-600 font-medium"><Database size={14}/> Connected to Cloud (Sheets)</span> 
                                        : 'โหมดออฟไลน์ (บันทึกในเครื่อง)'}
                                </p>
                            </div>
                            <div className="flex flex-col sm:flex-row gap-3">
                                <div className="input-3d rounded-lg p-1.5 flex flex-wrap items-center gap-2 px-3 text-sm text-slate-600 justify-center">
                                    <div className="flex items-center gap-2 w-full sm:w-auto justify-center">
                                        <Calendar size={16} className="shrink-0 text-blue-600" />
                                        <input type="date" value={dashboardDateRange.start} onChange={(e) => setDashboardDateRange({...dashboardDateRange, start: e.target.value})} className="outline-none bg-transparent w-32 font-medium" />
                                    </div>
                                    <span className="text-slate-300 font-bold">-</span>
                                    <div className="w-full sm:w-auto flex justify-center">
                                        <input type="date" value={dashboardDateRange.end} onChange={(e) => setDashboardDateRange({...dashboardDateRange, end: e.target.value})} className="outline-none bg-transparent w-32 font-medium" />
                                    </div>
                                </div>
                                <button onClick={openAddCustomerModal} className="flex items-center justify-center gap-2 btn-3d-blue text-white px-5 py-2.5 rounded-lg w-full sm:w-auto font-medium">
                                    <UserPlus size={18} className="icon-3d"/> <span>Add Customer</span>
                                </button>
                            </div>
                        </div>

                        {customers.length === 0 ? (
                            <div className="flex flex-col items-center justify-center p-12 bg-white rounded-3xl border-2 border-dashed border-slate-300 text-center card-3d bg-opacity-50">
                                <div className="btn-3d-white p-5 rounded-full mb-5"><Briefcase size={40} className="text-blue-500 icon-3d" /></div>
                                <h2 className="text-2xl font-bold text-slate-800 mb-2 drop-shadow-sm">เริ่มสร้างพอร์ตลูกค้าของคุณ</h2>
                                <p className="text-slate-500 mb-8 max-w-md">กดปุ่มด้านล่างเพื่อเพิ่มลูกค้าใหม่ หรือใช้ข้อมูลตัวอย่างเพื่อทดสอบระบบ</p>
                                <div className="flex gap-4">
                                    <button onClick={seedData} className="px-6 py-3 btn-3d-white rounded-lg font-medium flex items-center gap-2"><RefreshCcw size={18} /> ใช้ข้อมูลตัวอย่าง</button>
                                    <button onClick={openAddCustomerModal} className="px-6 py-3 btn-3d-blue text-white rounded-lg font-medium flex items-center gap-2"><UserPlus size={18} /> เพิ่มลูกค้าใหม่</button>
                                </div>
                            </div>
                        ) : (
                            <>
                                {/* --- ส่วนของผู้ดูแลระบบ (ภาพรวมทั้งทีม) --- */}
                                {user?.role === 'admin' && (
                                    <div className="mb-8 p-5 md:p-8 card-3d-purple rounded-3xl">
                                        <h2 className="text-xl font-bold text-purple-900 mb-5 flex items-center gap-2"><Building2 size={22} className="icon-3d"/> ภาพรวมทั้งทีม (Team Overview)</h2>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                                            <StatCard title="Team Revenue" value={`฿${(teamRevenue/1000000).toFixed(1)}M`} subtext="ยอดขายรวมทั้งทีม" trend="up" color="purple" />
                                            <StatCard title="Team Active" value={`${teamActiveCount} ราย`} subtext="ลูกค้า Active ทั้งทีม" trend="up" color="purple" />
                                            <StatCard title="Team Inactive" value={`${teamInactiveCount} ราย`} subtext="ลูกค้า Inactive ทั้งทีม" trend="down" color="red" />
                                            <StatCard title="Team Visit Plan" value={`${teamTodayPlans} ราย`} subtext="แผนเข้าเยี่ยมวันนี้ทั้งทีม" trend="up" color="purple" />
                                        </div>
                                    </div>
                                )}

                                {/* --- ส่วนของ User (ภาพรวมของฉัน) --- */}
                                <div>
                                    <h2 className="text-xl font-bold text-slate-800 mb-5 flex items-center gap-2"><User size={22} className="text-blue-600 icon-3d"/> ภาพรวมของฉัน (My Overview)</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                                        <StatCard title="My Revenue" value={`฿${(myRevenue/1000000).toFixed(1)}M`} subtext="ยอดขายของฉัน" trend="up" active={activeFilter === 'ALL'} onClick={() => setActiveFilter('ALL')} color="blue" />
                                        <StatCard title="My Active" value={`${myActiveCount} ราย`} subtext="คลิกเพื่อดูทั้งหมด" trend="up" active={activeFilter === 'ALL'} onClick={() => { setActiveFilter('ALL'); setCurrentView('customerList'); }} color="blue" />
                                        <StatCard title="My Inactive" value={`${myInactiveCount} ราย`} subtext="คลิกเพื่อกรอง Inactive" trend="down" color="red" active={activeFilter === 'INACTIVE'} onClick={() => { setActiveFilter('INACTIVE'); setCurrentView('customerList'); }} />
                                        <StatCard title="My Visit Plan" value={`${myTodayPlans} ราย`} subtext="แผนเข้าเยี่ยมวันนี้" trend="up" active={currentView === 'visitPlan'} onClick={() => setCurrentView('visitPlan')} color="blue" />
                                    </div>
                                </div>

                                <div className="card-3d rounded-3xl overflow-hidden mt-8">
                                    <div className="p-6 border-b border-blue-100 bg-gradient-to-r from-blue-50 to-slate-50 flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-white p-2 rounded-lg shadow-sm border border-slate-100"><Activity size={20} className="text-blue-600 icon-3d"/></div>
                                            <h2 className="font-bold text-slate-800 text-lg drop-shadow-sm"> 
                                                Activity Logs
                                                <span className="ml-3 text-xs font-medium text-slate-500 bg-white px-3 py-1 rounded-full border border-slate-200 shadow-inner">
                                                    ช่วงที่เลือก: {recentActivities.length} รายการ
                                                </span>
                                            </h2>
                                        </div>
                                    </div>
                                    <div className="divide-y divide-slate-100 bg-white">
                                        {recentActivities.length === 0 && <p className="p-10 text-center text-slate-500 font-medium">ไม่มีกิจกรรมในช่วงวันที่เลือก</p>}
                                        {recentActivities.map((act) => (
                                            <div key={act.id} className="p-5 hover:bg-slate-50 transition-all flex items-start justify-between group cursor-pointer" onClick={() => { setSelectedCustomerId(act.customerId); setCurrentView('customerDetail'); }}>
                                                <div className="flex gap-5">
                                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-base avatar-3d shrink-0 ${act.type === 'Visit' ? 'bg-blue-500' : act.type === 'Sale' ? 'bg-green-500' : act.type === 'System' ? 'bg-slate-500' : 'bg-orange-500'}`}>
                                                        {act.type.charAt(0)}
                                                    </div>
                                                    <div>
                                                        <div className="flex items-center gap-3">
                                                            <span className="font-bold text-slate-800 text-base group-hover:text-blue-600 transition-colors">{act.customerName}</span>
                                                            <span className="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200 shadow-sm font-bold tracking-wider uppercase">{act.type}</span>
                                                        </div>
                                                        <p className="text-sm text-slate-600 mt-1 leading-relaxed">{act.note}</p>
                                                        <div className="flex items-center gap-2 mt-2">
                                                            <p className="text-xs text-slate-500 flex items-center gap-1 font-medium bg-slate-50 px-2 py-0.5 rounded border border-slate-100"><Users size={10}/> {act.by}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="text-right shrink-0">
                                                    <p className="text-xs text-slate-500 font-medium">{safeDate(act.date).toLocaleDateString('th-TH')}</p>
                                                    <p className="text-xs text-slate-400 mt-0.5">{safeDate(act.date).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                );
            };

            return (
                <div className="flex min-h-screen font-sans text-slate-900 bg-[#f1f5f9]">
                    {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg(null)} />}
                    {renderAddCustomerModal()}
                    {renderAddVisitPlanModal()} 
                    {renderUpdateRevenueModal()}
                    
                    <div className={`w-64 sidebar-3d text-slate-300 flex-col fixed h-full z-30 transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
                        <div className="p-6 border-b border-slate-700/50 flex justify-between items-center bg-slate-900/50 backdrop-blur-md">
                            <h1 className="text-xl font-bold tracking-tight text-white flex items-center gap-3">
                                <div className="avatar-3d bg-white p-1.5 rounded-lg">
                                     <span className="text-blue-700 font-black text-xl drop-shadow-sm">HP</span>
                                </div>
                                <span className="text-lg drop-shadow-md">Owner OS</span>
                            </h1>
                            <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden text-slate-400 hover:text-white transition-colors"><X size={24} /></button>
                        </div>
                        <div className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 px-3 mt-2 drop-shadow-sm">Menu</div>
                            <div onClick={() => { setCurrentView('dashboard'); setIsSidebarOpen(false); }} className={`flex items-center gap-3 p-3.5 rounded-xl cursor-pointer transition-all ${currentView === 'dashboard' ? 'btn-3d-blue text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                <LayoutDashboard size={20} className={currentView === 'dashboard' ? 'icon-3d' : ''} /><span className="font-medium">Dashboard</span>
                            </div>
                            <div onClick={() => { setCurrentView('customerList'); setIsSidebarOpen(false); }} className={`flex items-center space-x-3 p-3.5 rounded-xl cursor-pointer transition-all ${currentView === 'customerList' ? 'btn-3d-blue text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                <List size={20} className={currentView === 'customerList' ? 'icon-3d' : ''} /><span className="font-medium">Customer List</span>
                            </div>
                            
                            {/* NEW MENU: Visit Plan */}
                            <div onClick={() => { setCurrentView('visitPlan'); setIsSidebarOpen(false); }} className={`flex items-center space-x-3 p-3.5 rounded-xl cursor-pointer transition-all ${currentView === 'visitPlan' ? 'btn-3d-blue text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                <div className="relative">
                                    <CalendarCheck size={20} className={currentView === 'visitPlan' ? 'icon-3d' : ''} />
                                    {dueVisitCount > 0 && (
                                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center animate-pulse shadow-md border border-red-400">
                                            {dueVisitCount}
                                        </span>
                                    )}
                                </div>
                                <span className="font-medium">Visit Plan</span>
                            </div>

                             {/* Settings Menu */}
                            <div onClick={() => { setCurrentView('settings'); setIsSidebarOpen(false); }} className={`flex items-center space-x-3 p-3.5 rounded-xl cursor-pointer transition-all ${currentView === 'settings' ? 'btn-3d-blue text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                <Settings size={20} className={currentView === 'settings' ? 'icon-3d' : ''} /><span className="font-medium">ตั้งค่าผู้ใช้งาน</span>
                            </div>

                            {/* Admin Menu */}
                            {user?.role === 'admin' && (
                                <>
                                    <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 px-3 mt-8 drop-shadow-sm">Admin Zone</div>
                                    <div onClick={() => { setCurrentView('userManagement'); setIsSidebarOpen(false); }} className={`flex items-center space-x-3 p-3.5 rounded-xl cursor-pointer transition-all ${currentView === 'userManagement' ? 'btn-3d-blue text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                        <UserCog size={20} className={currentView === 'userManagement' ? 'icon-3d' : ''} /><span className="font-medium">Manage Users</span>
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="p-5 border-t border-slate-800 bg-slate-900/30">
                            <div className="flex items-center gap-3 mb-5">
                                <div className="w-10 h-10 rounded-full btn-3d-blue flex items-center justify-center text-sm font-bold overflow-hidden avatar-3d text-white">
                                    {user?.photoURL ? (
                                        <img src={user.photoURL} alt="Profile" className="w-full h-full object-cover" />
                                    ) : (
                                        (user?.displayName || user?.username || "U").substring(0, 2).toUpperCase()
                                    )}
                                </div>
                                <div>
                                    <p className="text-sm font-bold text-slate-200">{user?.displayName || 'Sales Rep'}</p>
                                    <p className="text-xs text-blue-400 font-medium drop-shadow-sm">Online ({user?.role === 'admin' ? 'Admin' : 'User'})</p>
                                </div>
                            </div>
                            <button 
                                type="button"
                                onClick={handleLogout}
                                className="w-full btn-3d-dark py-2.5 rounded-xl hover:text-white transition-all text-sm flex items-center justify-center gap-2 font-medium"
                            >
                                <LogOut size={16} /> ออกจากระบบ
                            </button>
                            
                            <div className="mt-6 pt-4 border-t border-slate-800/50 text-center">
                                <p className="text-[10px] text-slate-500 opacity-50 leading-relaxed font-light hover:opacity-100 transition-opacity">
                                    B2B Owner OS 2025-2026; <br/>
                                    All rights reserved by <br/>
                                    Niwat Phongsuwan (ฺB2B Officer)
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 lg:ml-64 transition-all duration-300 relative z-10">
                        {/* Header Navbar */}
                        <div className="bg-gradient-to-b from-white to-slate-50 h-16 border-b border-slate-200 flex items-center justify-between px-4 lg:px-8 sticky top-0 z-20 shadow-[0_4px_10px_rgba(0,0,0,0.03)]">
                            <div className="flex items-center gap-3 lg:hidden">
                                <button onClick={() => setIsSidebarOpen(true)} className="text-slate-500 hover:text-slate-800 transition-colors p-1 bg-slate-100 rounded-md border border-slate-200 shadow-sm"><Menu size={24} /></button>
                                <div className="font-bold text-slate-800 flex items-center gap-2">
                                     <span className="text-blue-800 font-black drop-shadow-sm">HP</span>
                                     <span className="hidden sm:inline font-bold">Owner OS</span>
                                </div>
                            </div>
                            <div className="flex-1 max-w-xl mx-auto ml-3 lg:ml-auto relative group">
                                <Search className="absolute left-3 top-2.5 text-slate-400 z-10 group-focus-within:text-blue-500 transition-colors" size={18} />
                                <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="ค้นหาจากทุกข้อมูล (ชื่อ, เบอร์, จังหวัด...)" className="w-full input-3d rounded-full pl-10 pr-4 py-2 text-sm" />
                            </div>
                        </div>
                        
                        {/* Main Content Area */}
                        <div className="p-4 md:p-8 max-w-7xl mx-auto w-full min-h-[calc(100vh-4rem)]">
                            {currentView === 'dashboard' ? renderDashboardView() : 
                             currentView === 'customerList' ? renderCustomerListView() :
                             currentView === 'customerDetail' ? renderCustomerDetailView() : 
                             currentView === 'settings' ? renderUserSettingsView() :
                             currentView === 'userManagement' ? renderUserManagementView() : 
                             currentView === 'visitPlan' ? renderVisitPlanView() : null}
                        </div>
                    </div>
                </div>
            );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<B2BAppFullStack />);
    </script>
</body>
</html>
